delete from contarbn.ditta_info;

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(1, 'NOME_AZIENDA', 'Nome azienda', 'Nome azienda', 'URBANI ALIMENTARI SNC di Urbani Elia e Marta', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(2, 'INDIRIZZO', 'Indirizzo', 'Indirizzo', 'Via 11 Settembre', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(3, 'CIVICO', 'Civico', 'Civico', '17', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(4, 'CITTA', 'Citta', 'Citta', 'San Giovanni Ilarione', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(5, 'PROVINCIA', 'Provincia', 'Provincia', 'Verona', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(6, 'CAP', 'Cap', 'Cap', '37035', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(7, 'PARTITA_IVA', 'Partita iva', 'Partita iva', '04998580239', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(8, 'CODICE_FISCALE', 'Codice fiscale', 'Codice fiscale', '04998580239', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(9, 'REA', 'Rea', 'Rea', 'VR462414', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(10, 'TELEFONO', 'Telefono', 'Telefono', '045 6550993', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(11, 'CELLULARE', 'Cellulare', 'Cellulare', '328 4694654', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(12, 'WEBSITE', 'Website', 'Website', 'www.urbanialimentari.com', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(13, 'EMAIL', 'Email', 'Email', 'info@urbanialimentari.com', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(14, 'PEC', 'Pec', 'Pec', 'rbn.snc@legalmail.it', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(15, 'PDF_INTESTAZIONE', 'Report PDF intestazione', 'Report PDF intestazione', 'URBANI ALIMENTARI SNC di Urbani Elia e Marta', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(16, 'PDF_INTESTAZIONE_2', 'Report PDF intestazione 2', 'Report PDF intestazione 2', 'gastronomia â€“ pasta fresca', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(17, 'PDF_INDIRIZZO', 'Report PDF indirizzo', 'Report PDF indirizzo', '37035 SAN GIOVANNI ILARIONE / VR - Via 11 Settembre, 17', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(18, 'RIBA_CODICE_SIA', 'RiBa codice SIA', 'RiBa codice SIA', 'C2JK0', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(19, 'RIBA_CODICE_ABI', 'RiBa codice ABI', 'RiBa codice ABI', '02008', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(20, 'RIBA_CODICE_CAB', 'RiBa codice CAB', 'RiBa codice CAB', '59752', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(21, 'RIBA_CONTO_CORRENTE', 'RiBa conto corrente', 'RiBa conto corrente', '000106913591', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(22, 'RIBA_NOME_AZIENDA', 'RiBa nome azienda', 'RiBa nome azienda', 'URBANI ALIM. SNC', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(23, 'RIBA_CAP_CITTA', 'RiBa cap citta', 'RiBa cap citta', '37035 S. Giovanni', b'0', now(), now());

INSERT INTO contarbn.ditta_info (id, codice, dato, descrizione, valore, deletable, data_inserimento, data_aggiornamento)
VALUES(24, 'RIBA_CITTA_PROVINCIA', 'RiBa citta provincia', 'RiBa citta provincia', 'Ilarione (VR)', b'0', now(), now());

-- #######################################################################################################################
alter table contarbn.produzione_ingrediente add `percentuale` decimal(10,3) DEFAULT NULL;

create or replace view contarbn.v_produzione_etichetta_sub as
select
    produzione.id,
    produzione.lotto,
    produzione.scadenza,
    produzione.barcode_ean_13,
    produzione.barcode_ean_128,
    ricetta.nome as articolo,
    ricetta.valori_nutrizionali,
    ricetta.conservazione,
    ingrediente.descrizione,
    produzione_ingrediente.percentuale,
    case
        when produzione_ingrediente.percentuale is null then
            ingrediente.descrizione
        else
            concat(ingrediente.descrizione, ' ', produzione_ingrediente.percentuale, '%')
        end as ingrediente_descrizione
from contarbn.produzione
         join contarbn.ricetta on
    ((produzione.id_ricetta = ricetta.id))
         left join contarbn.produzione_ingrediente on
    ((produzione.id = produzione_ingrediente.id_produzione))
         left join contarbn.ingrediente on
    ((produzione_ingrediente.id_ingrediente = ingrediente.id));

create or replace view contarbn.v_produzione_etichetta as
select
    pe.id,
    pe.lotto,
    pe.scadenza,
    pe.barcode_ean_13,
    pe.barcode_ean_128,
    pe.articolo,
    group_concat(distinct pe.ingrediente_descrizione order by pe.percentuale desc, pe.descrizione asc separator ',') as `ingredienti`,
    pe.valori_nutrizionali,
    pe.conservazione
from contarbn.v_produzione_etichetta_sub as pe
group by
    pe.id,
    pe.lotto,
    pe.scadenza,
    pe.barcode_ean_13,
    pe.barcode_ean_128,
    pe.articolo,
    pe.valori_nutrizionali,
    pe.conservazione
;

UPDATE contarbn.produzione_ingrediente pi2
INNER JOIN (
    select
        t2.*,
        round((t2.quantita*100/t2.quantita_totale),2) as percentuale
    from(
        select
            pi3.id_produzione,
            pi3.id_ingrediente,
            pi3.uuid,
            pi3.quantita,
            t.quantita_totale
        from contarbn.produzione_ingrediente pi3
        join (
            select
                pi2.id_produzione,
                SUM(pi2.quantita) as quantita_totale
            from contarbn.produzione_ingrediente pi2
            group by
                pi2.id_produzione
        ) t on
            pi3.id_produzione = t.id_produzione
    ) t2
) t ON
    pi2.id_produzione = t.id_produzione and
    pi2.id_ingrediente = t.id_ingrediente and
    pi2.uuid = t.uuid
SET pi2.percentuale = t.percentuale
;